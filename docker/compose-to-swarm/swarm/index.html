


<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="All about Docker, K8 and Containers in general">
      
      
      
        <meta name="author" content="Marcos Cano">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.0">
    
    
      
        <title>Swarm Steps - kontinu</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.b5d04df8.min.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.9ab2c1f8.min.css">
      
      
        
        
        <meta name="theme-color" content="#757575">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CInconsolata&display=fallback">
        <style>body,input{font-family:"Ubuntu",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Inconsolata",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../assets/css/extra.css">
    
      <link rel="stylesheet" href="../../../assets/css/contact_form.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#swarm-steps" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Cabecera">
    <a href="../../.." title="kontinu" class="md-header-nav__button md-logo" aria-label="kontinu">
      
  <img src="../../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            kontinu
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Swarm Steps
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="B√∫squeda" placeholder="B√∫squeda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

<nav class="md-tabs" aria-label="Pesta√±as" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link md-tabs__link--active">
        Inicio
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../semana1/d1/" class="md-tabs__link">
          Semana 1Ô∏è
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../semana2/d1/" class="md-tabs__link">
          Semana 2
        </a>
      
    </li>
  

      
        
      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../extras/extras/" class="md-tabs__link">
          Extras
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navegaci√≥n" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="kontinu" class="md-nav__button md-logo" aria-label="kontinu">
      
  <img src="../../../assets/images/logo.png" alt="logo">

    </a>
    kontinu
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Inicio" class="md-nav__link">
      Inicio
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Semana 1Ô∏è
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Semana 1Ô∏è" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Semana 1Ô∏è
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      D√≠a 1
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="D√≠a 1" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        D√≠a 1
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../semana1/d1/" title="D√≠a 1" class="md-nav__link">
      D√≠a 1
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../semana1/d2/" title="D√≠a 2" class="md-nav__link">
      D√≠a 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../semana1/d3/" title="D√≠a 3" class="md-nav__link">
      D√≠a 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Semana 2
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Semana 2" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Semana 2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../semana2/d1/" title="D√≠a 1" class="md-nav__link">
      D√≠a 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../semana2/d2/" title="D√≠a 2" class="md-nav__link">
      D√≠a 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../semana2/d3/" title="D√≠a 3" class="md-nav__link">
      D√≠a 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../about/" title="Acerca de Mi" class="md-nav__link">
      Acerca de Mi
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../contact/" title="Contacto" class="md-nav__link">
      Contacto
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Extras
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Extras" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Extras
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../extras/extras/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../extras/agenda/" title="Agenda" class="md-nav__link">
      Agenda
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../extras/feedback/" title="Feedback" class="md-nav__link">
      Feedback
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-git-clone" class="md-nav__link">
    0. git clone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-enable-visualizer-on-port-8080" class="md-nav__link">
    1. Enable Visualizer on port 8080
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-simple-service-create" class="md-nav__link">
    2. Simple service create
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-simple-stack-deploy" class="md-nav__link">
    3. Simple Stack deploy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-environment-variables-injection" class="md-nav__link">
    4. Environment Variables injection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-scale-web-app" class="md-nav__link">
    5. Scale web app
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-declarative-deployment-replicas" class="md-nav__link">
    6. Declarative Deployment Replicas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-rolling-updates" class="md-nav__link">
    7. Rolling Updates
  </a>
  
    <nav class="md-nav" aria-label="7. Rolling Updates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lets-force-update-to-see-the-rolling-updates" class="md-nav__link">
    Lets force update to see the rolling updates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-host-limit-resource" class="md-nav__link">
    8. Host limit resource
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-health-check-and-self-healing" class="md-nav__link">
    9. Health Check and Self healing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-production-lb" class="md-nav__link">
    Full Production + LB
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="swarm-steps">Swarm Steps<a class="headerlink" href="#swarm-steps" title="Permanent link">&para;</a></h1>
<h2 id="0-git-clone">0. git clone<a class="headerlink" href="#0-git-clone" title="Permanent link">&para;</a></h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>git clone https://github.com/jmarcos-cano/compose-to-swarm.git
<span class="nb">cd</span> compose-to-swarm
</code></pre></div>
</td></tr></table>

<h2 id="1-enable-visualizer-on-port-8080">1. Enable Visualizer on port 8080<a class="headerlink" href="#1-enable-visualizer-on-port-8080" title="Permanent link">&para;</a></h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker service create <span class="se">\</span>
  --name<span class="o">=</span>viz <span class="se">\</span>
  --publish<span class="o">=</span><span class="m">8080</span>:8080/tcp <span class="se">\</span>
  --constraint<span class="o">=</span>node.role<span class="o">==</span>manager <span class="se">\</span>
  --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,src<span class="o">=</span>/var/run/docker.sock,dst<span class="o">=</span>/var/run/docker.sock <span class="se">\</span>
  dockersamples/visualizer

<span class="c1"># wait until it says &quot;service converged&quot;</span>
</code></pre></div>
</td></tr></table>

<details class="info"><summary>‚ö†Ô∏è</summary><p>go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<hr />
<h2 id="2-simple-service-create">2. Simple service create<a class="headerlink" href="#2-simple-service-create" title="Permanent link">&para;</a></h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># Create a swarm service from a Nginx docker image</span>
docker service create --name nginx-ws -p <span class="m">80</span>:80 nginx

<span class="c1"># List the current services</span>
docker service ls
</code></pre></div>
</td></tr></table>

<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.
Click also on Port 80 (Nginx) - it should say "Welcome to Nginx"</p>
</details>
<p><strong>Scale the service</strong>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker service update --replicas <span class="m">3</span> nginx-ws
</code></pre></div>
</td></tr></table></p>
<blockquote>
<p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</blockquote>
<p><strong>Checking service logs</strong>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker service logs nginx-ws
</code></pre></div>
</td></tr></table></p>
<p><strong>Delete the service</strong>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker service rm nginx-ws

<span class="c1"># check for running services</span>
docker service ls
</code></pre></div>
</td></tr></table></p>
<hr />
<h2 id="3-simple-stack-deploy">3. Simple Stack deploy<a class="headerlink" href="#3-simple-stack-deploy" title="Permanent link">&para;</a></h2>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># inspect the stack file and try to understand it</span>
cat docker-compose.simple.yml
<span class="c1"># deploy it</span>
docker stack deploy -c docker-compose.simple.yml --resolve-image<span class="o">=</span>always --with-registry-auth compose_swarm

<span class="c1"># list current services</span>
docker service ls
</code></pre></div>
</td></tr></table>
<br></p>
<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your app (click in your upper link port 500) and see how the app looks like. !
Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<p>Show current status
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker stack ps compose_swarm
</code></pre></div>
</td></tr></table></p>
<hr />
<h2 id="4-environment-variables-injection">4. Environment Variables injection<a class="headerlink" href="#4-environment-variables-injection" title="Permanent link">&para;</a></h2>
<blockquote>
<p>üí° This will give you a small intro to how you can manage configuration per environment (dev,qa,stage,production)</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># inspect the stack file and try to find the directive &quot;FOO=${FOO:-BAR}&quot;</span>
cat docker-compose.simple.yml

<span class="c1"># inject the new value</span>
<span class="nb">export</span> <span class="nv">FOO</span><span class="o">=</span><span class="s2">&quot;Development&quot;</span>

<span class="c1"># deploy it and see it update automatically</span>
docker stack deploy -c docker-compose.simple.yml --resolve-image<span class="o">=</span>always --with-registry-auth compose_swarm

docker stack services compose_swarm
</code></pre></div>
</td></tr></table>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># PROD</span>
docker stack deploy -c &lt;<span class="o">(</span>docker-compose --env-file .configs/production.env -f docker-compose.simple.yml config <span class="o">)</span> --resolve-image<span class="o">=</span>always --with-registry-auth compose_swarm_prod
</code></pre></div>
</td></tr></table>

<p><br></p>
<details class="info"><summary>ü•á</summary><p>Dare you to put your own Text there, see how sometimes the application becomes unaccessible?</p>
</details>
<hr />
<h2 id="5-scale-web-app">5. Scale web app<a class="headerlink" href="#5-scale-web-app" title="Permanent link">&para;</a></h2>
<ul>
<li>Want to handle more traffic?</li>
<li>Want to be more resilient?</li>
<li>Want High Availability?</li>
</ul>
<p>Swarm got you covered</p>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker service scale <span class="nv">compose_swarm_web</span><span class="o">=</span><span class="m">4</span>
</code></pre></div>
</td></tr></table>
<br></p>
<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your app (click in your upper link port 500) and see how which task/container responds
Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<hr />
<h2 id="6-declarative-deployment-replicas">6. Declarative Deployment Replicas<a class="headerlink" href="#6-declarative-deployment-replicas" title="Permanent link">&para;</a></h2>
<p>Instead of scaling your service everytime, why don't we declare it?</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># Inspect the .replicas file and find &quot;deploy: &quot; section</span>
cat compose/docker-compose.replicas.yml

<span class="c1"># Deploy new update for the stack</span>
<span class="nv">DEPLOYMENT_REPLICAS</span><span class="o">=</span><span class="m">7</span> docker stack deploy -c compose/docker-compose.replicas.yml --resolve-image<span class="o">=</span>always compose_swarm
</code></pre></div>
</td></tr></table>

<details class="info"><summary>‚ö†Ô∏è</summary><p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</details>
<hr />
<h2 id="7-rolling-updates">7. Rolling Updates<a class="headerlink" href="#7-rolling-updates" title="Permanent link">&para;</a></h2>
<p>Rolling updates let you update your app with zero-downtime.
<br></p>
<blockquote>
<p>üí° v1 has been running for 2 weeks now and you are ready to ship your new and hottest feature on v2, with rolling updates you can easily ship v2 let it coexist with v1 until v1 gets fully drain (removed) and v2 gets out.</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># inspect .rolling file and find the &quot;update_config:&quot; section, try to understand it</span>
less compose/docker-compose.rolling.yml


<span class="c1"># Deploy/update this new configuration for your stack</span>
docker stack deploy -c &lt;<span class="o">(</span>docker-compose -f compose/docker-compose.rolling.yml config<span class="o">)</span> --resolve-image<span class="o">=</span>always compose_swarm

<span class="c1"># update image</span>
docker stack deploy -c &lt;<span class="o">(</span><span class="nv">IMAGE_NAME</span><span class="o">=</span>mcano/compose-to-swarm:v2 docker-compose -f compose/docker-compose.rolling.yml config<span class="o">)</span> --resolve-image<span class="o">=</span>always compose_swarm
</code></pre></div>
</td></tr></table>

<h4 id="lets-force-update-to-see-the-rolling-updates">Lets force update to see the rolling updates<a class="headerlink" href="#lets-force-update-to-see-the-rolling-updates" title="Permanent link">&para;</a></h4>
<p>Do this how many times you need in order to see it working.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># graceful full restart of your app</span>
docker service update --force compose_swarm_web
</code></pre></div>
</td></tr></table>

<blockquote>
<p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread.</p>
</blockquote>
<hr />
<h2 id="8-host-limit-resource">8. Host limit resource<a class="headerlink" href="#8-host-limit-resource" title="Permanent link">&para;</a></h2>
<p>One can prevent memory starvation or CPU consumption of your app by adding "resources:" section</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># inspect .resources file and find the &quot;resources:&quot; section, try to understand it</span>
less compose/docker-compose.resources.yml

<span class="c1"># Deploy/update this new configuration for your stack</span>
docker stack deploy -c compose/docker-compose.resources.yml --resolve-image<span class="o">=</span>always compose_swarm
</code></pre></div>
</td></tr></table>

<h2 id="9-health-check-and-self-healing">9. Health Check and Self healing<a class="headerlink" href="#9-health-check-and-self-healing" title="Permanent link">&para;</a></h2>
<p>Auto restarts and health-check can also be possible by adding "healthcheck: "</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># Run docker ps first to see there&#39;s no (healthy)</span>
docker ps

<span class="c1"># inspect .health file and find the &quot;healthcheck:&quot; section, try to understand it</span>
less compose/docker-compose.health.yml

<span class="c1"># Deploy/update this new configuration for your stack</span>
docker stack deploy -c compose/docker-compose.health.yml --resolve-image<span class="o">=</span>always compose_swarm

<span class="c1"># after a few seconds run</span>
docker ps
</code></pre></div>
</td></tr></table>

<p>Do a: <code>docker service ps compose_swarm_web</code>, Identify the placement of a container (identify on which node is running).</p>
<p>Jump into that node and run <code>docker ps</code> find the container and its ID (first column), kill it and see how it self heals
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker <span class="nb">kill</span> &lt;container ID&gt;
</code></pre></div>
</td></tr></table></p>
<details class="info"><summary>info</summary><p>Go to your visualizer (click in your upper link port 8080) and see how the services are spread and self healed.</p>
</details>
<h2 id="full-production-lb">Full Production + <a href="http://138-197-49-123.nip.io/make">LB</a><a class="headerlink" href="#full-production-lb" title="Permanent link">&para;</a></h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>docker stack deploy -c &lt;(docker-compose --env-file .configs/production.env -f docker-compose.yml config ) --resolve-image=always --with-registry-auth compose_swarm_prod

open http://138-197-49-123.nip.io/
</code></pre></div>
</td></tr></table>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/Marcos_Kno" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5 0 86.7-66 186.6-186.6 186.6-37.2 0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7 0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447 0 01-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9 0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://github.com/kontinu" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://hub.docker.com/orgs/kontinu" target="_blank" rel="noopener" title="hub.docker.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
      </a>
    
      
      
      <a href="www.kontinu.io" target="_blank" rel="noopener" title="" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.92ffa368.min.js"></script>
      <script src="../../../assets/javascripts/bundle.5123e3d4.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: ["instant", "tabs"],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>